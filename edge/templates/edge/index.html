<!-- Set-up -->
{% load static %} {% csrf_token %}
<link rel="stylesheet" type="text/css" href="{% static 'edge/style.css' %}" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<!-- Intro; consider moving to base.html -->
<h1>Global Policy Lab | Aerial History Project</h1>
<h1>Stitching</h1>

<!-- Edge photos -->
<column>
  <div class="row">
    {% for image, imnum in image_list %}
    <div class="column">
      <h2>{{imnum}}: {{ image|slice:"5:" }}</h2>
      {% if image %}
      <ul>
        <canvas
          id="{{imnum}}"
          width="512"
          height="512"
          style="border: 5px solid #000000;"
        ></canvas>
        <h2>Coordinate:</h2>
        <h2 id="{{imnum}}Coordinates"></h2>
      </ul>
      {% else %}
      <h1><p>Try reloading photo.</p></h1>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</column>

<!-- Save points button -->
<button style=onclick="recordCoordinates();"> Record</button>

<!-- Script visualization button -->
<button style=onclick="visualizeMerge();"> Visualize</button>

<!-- Post button -->
<button onclick="saveCoordinates();">Save coordinates</button>

<!-- Output photo -->
<h1>Output [pending]</h1>

<script language="javascript">
  var canvas = document.getElementById("im1");
  var ctx = canvas.getContext("2d");
  ctx.fillStyle = "#FF0000";

  var canvas2 = document.getElementById("im2");
  var ctx2 = canvas2.getContext("2d");
  ctx2.fillStyle = "#00FF00";

  var curX, curY;
  var curX2, curY2;

  var canvas_data = [];

  // Tuning parameters

  var tuningX = 0;
  var tuningY = 0;

  // Helper Functions
  function saveCoordinates() {
    // var curX = curX;
    // var curY = curY;
    // var curX2 = curX2;
    // var curY2 = curY2;
    $.ajax({
      type: "POST",
      //   url: "/edge/save/",
      url: '{% url "edge:save" %}',
      data: {
        im1_name: "{{image_list.0.0}}",
        im2_name: "{{image_list.1.0}}",
        im1_x: curX,
        im1_y: curY,
        im2_x: curX2,
        im2_y: curY2,
        csrfmiddlewaretoken: "{{ csrf_token }}"
      },
      dataType: "json",
      success: function(data) {
        alert("Successfully saved coordinate.");
      },
      failure: function(data) {
        alert("Failed!");
      }
    });
  }

  function updateLatestCoordinates1(curX, curY) {
    document.getElementById("im1Coordinates").innerHTML = curX + " " + curY;
  }

  function updateLatestCoordinates2(curX2, curY2) {
    document.getElementById("im2Coordinates").innerHTML = curX2 + " " + curY2;
  }

  function onload1() {
    var background = new Image();
    background.src = "{% static image_list.0.0 %}";
    background.onload = () => {
      ctx.drawImage(background, 0, 0, 512, 512);
    };
  }
  function onload2() {
    var background = new Image();
    background.src = "{% static image_list.1.0 %}";
    background.onload = () => {
      ctx2.drawImage(background, 0, 0, 512, 512);
    };
  }

  function listen() {
    canvas.onmousedown = function(e) {
      curX = e.clientX - canvas.offsetLeft + tuningX;
      curY = e.clientY - canvas.offsetTop + tuningY;
      updateLatestCoordinates1(curX, curY);
      hold = true;
      ctx.fillRect(curX, curY, 5, 5);
    };

    canvas2.onmousedown = function(e) {
      curX2 = e.clientX - canvas2.offsetLeft + tuningX;
      curY2 = e.clientY - canvas2.offsetTop + tuningY;
      updateLatestCoordinates2(curX2, curY2);
      hold = true;
      ctx2.fillRect(curX2, curY2, 5, 5);
    };
  }
  window.onload = function() {
    onload1();
    onload2();
    listen();
  };
</script>
